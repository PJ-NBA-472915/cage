{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/task.schema.json",
  "title": "Task File",
  "type": "object",
  "additionalProperties": true,
  "required": [
    "id",
    "title",
    "owner",
    "status",
    "created_at",
    "updated_at",
    "progress_percent",
    "tags",
    "summary",
    "success_criteria",
    "acceptance_checks",
    "subtasks",
    "todo",
    "changelog",
    "decisions",
    "lessons_learned",
    "issues_risks",
    "next_steps",
    "references",
    "prompts",
    "locks",
    "migration",
    "metadata"
  ],
  "properties": {
    "id": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}-[a-z0-9-]+$" },
    "title": { "type": "string", "minLength": 1 },
    "owner": { "type": "string", "minLength": 1 },
    "status": { "type": "string", "enum": ["planned", "in-progress", "blocked", "review", "done", "abandoned"] },
    "created_at": { "type": "string" },
    "updated_at": { "type": "string" },
    "progress_percent": { "type": "integer", "minimum": 0, "maximum": 100 },
    "tags": { "type": "array", "items": { "type": "string" } },
    "summary": { "type": "string" },

    "success_criteria": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "text",
          "checked"
        ],
        "properties": {
          "text": {
            "type": "string"
          },
          "checked": {
            "type": "boolean"
          },
          "verified_at": {
            "type": [
              "string",
              "null"
            ]
          },
          "evidence": {
            "type": [
              "string",
              "null"
            ]
          },
          "verified_by": {
            "type": [
              "string",
              "null"
            ],
            "enum": [
              "manual_test",
              "automated_test",
              "code_review",
              "user_approval",
              null
            ]
          }
        },
        "additionalProperties": false
      }
    },
    "acceptance_checks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "text",
          "checked"
        ],
        "properties": {
          "text": {
            "type": "string"
          },
          "checked": {
            "type": "boolean"
          },
          "verified_at": {
            "type": [
              "string",
              "null"
            ]
          },
          "evidence": {
            "type": [
              "string",
              "null"
            ]
          },
          "verified_by": {
            "type": [
              "string",
              "null"
            ],
            "enum": [
              "manual_test",
              "automated_test",
              "code_review",
              "user_approval",
              null
            ]
          }
        },
        "additionalProperties": false
      }
    },
    "subtasks": { "type": "array", "items": { "type": "string" } },

    "todo": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "text",
          "status"
        ],
        "properties": {
          "text": {
            "type": "string"
          },
          "status": {
            "type": "string",
            "enum": [
              "not-started",
              "done",
              "blocked",
              "failed"
            ]
          },
          "date_started": {
            "type": [
              "string",
              "null"
            ]
          },
          "date_stopped": {
            "type": [
              "string",
              "null"
            ]
          }
        },
        "additionalProperties": false
      }
    },
    "changelog": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "timestamp",
          "text"
        ],
        "properties": {
          "timestamp": {
            "type": "string"
          },
          "text": {
            "type": "string"
          },
          "lock_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "file_path": {
            "type": [
              "string",
              "null"
            ]
          }
        },
        "additionalProperties": false
      }
    },
    "decisions": { "type": "array", "items": { "type": "string" } },
    "lessons_learned": {
      "type": "array",
      "items": {
        "oneOf": [
          {
            "type": "string"
          },
          {
            "type": "object",
            "required": [
              "category",
              "lesson",
              "context",
              "applicable_to"
            ],
            "properties": {
              "category": {
                "type": "string",
                "enum": [
                  "technical",
                  "process",
                  "tooling",
                  "communication",
                  "infrastructure"
                ]
              },
              "lesson": {
                "type": "string"
              },
              "context": {
                "type": "string"
              },
              "applicable_to": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            },
            "additionalProperties": false
          }
        ]
      }
    },
    "issues_risks": { "type": "array", "items": { "type": "string" } },
    "next_steps": { "type": "array", "items": { "type": "string" } },
    "references": { "type": "array", "items": { "type": "string" } },
    "prompts": {
      "type": "array",
      "default": [],
      "items": {
        "type": "object",
        "required": [
          "timestamp",
          "text",
          "context",
          "type"
        ],
        "properties": {
          "timestamp": {
            "type": "string"
          },
          "text": {
            "type": "string"
          },
          "context": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "enum": [
              "initial_request",
              "clarification",
              "feedback",
              "approval",
              "rejection",
              "follow_up"
            ]
          }
        },
        "additionalProperties": false
      }
    },
    "locks": {
      "description": "Cooperative file locks for multi-agent collaboration.",
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "id",
          "file_path",
          "ranges",
          "description",
          "agent",
          "started_at",
          "status"
        ],
        "properties": {
          "id": {
            "type": "string",
            "minLength": 1
          },
          "file_path": {
            "type": "string",
            "minLength": 1
          },
          "ranges": {
            "description": "One or more line ranges the agent intends to modify.",
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "start_line",
                "end_line"
              ],
              "properties": {
                "start_line": {
                  "type": "integer",
                  "minimum": 1
                },
                "end_line": {
                  "type": "integer",
                  "minimum": 1
                }
              }
            }
          },
          "description": {
            "type": "string"
          },
          "agent": {
            "type": "string",
            "minLength": 1
          },
          "started_at": {
            "type": "string"
          },
          "completed_at": {
            "type": [
              "string",
              "null"
            ]
          },
          "status": {
            "type": "string",
            "enum": [
              "active",
              "released",
              "aborted",
              "stale"
            ]
          }
        }
      }
    },
    "migration": {
      "type": "object",
      "required": ["migrated"],
      "properties": {
        "migrated": { "type": "boolean" },
        "source_path": { "type": ["string", "null"] },
        "method": { "type": ["string", "null"], "enum": ["script", "manual", null] },
        "migrated_at": { "type": ["string", "null"] }
      },
      "additionalProperties": false
    },

    "metadata": { "type": "object", "additionalProperties": true }
  }
}
